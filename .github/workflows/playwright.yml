name: Quality Gates
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to read commit messages accurately

      - name: Setup Node & Python
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          npm ci
          npx playwright install --with-deps
          pip install pytest requests

      - name: Execute Targeted Suite
        run: |
          MSG=$(git log -1 --pretty=%B)
          echo "Commit Message: $MSG"
          
          if [[ "$MSG" == *"#perf"* ]]; then
            curl -L https://github.com/grafana/k6/releases/download/v0.49.0/k6-v0.49.0-linux-amd64.tar.gz | tar -xz
            ./k6-v0.49.0-linux-amd64/k6 run tests_perf/smoke-load.js --summary-export=k6-summary.json
          
          elif [[ "$MSG" == *"#api"* ]]; then
            pytest tests_python/ --junitxml=pytest-report.xml
          
          elif [[ "$MSG" == *"#full"* ]]; then
            npm run test:full
            pytest tests_python/ --junitxml=pytest-report.xml || true
          
          else
            echo "Defaulting to Smoke Suite"
            npx playwright test --grep @smoke
          fi

      - name: Archive Quality Bundle
        uses: actions/upload-artifact@v4
        if: always() 
        with:
          name: quality-report-bundle
          path: |
            playwright-report/
            pytest-report.xml
            k6-summary.json
          if-no-files-found: warn
          retention-days: 30
name: Intelligence Gate
on: [push, pull_request]

jobs:
  parse-intent:
    runs-on: ubuntu-latest
    outputs:
      test_type: ${{ steps.filter.outputs.type }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        run: |
          MSG=$(git log -1 --pretty=%B)
          if [[ "$MSG" == *"#full"* ]]; then echo "type=full" >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"#api"* ]]; then echo "type=api" >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"#billing"* ]]; then echo "type=billing" >> $GITHUB_OUTPUT
          else echo "type=smoke" >> $GITHUB_OUTPUT
          fi

  execute:
    needs: parse-intent
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm install && npx playwright install --with-deps

      - name: Run Targeted Suite
        run: |
          case "${{ needs.parse-intent.outputs.test_type }}" in
            "full") npm run test:full ;;
            "api") npm run test:api ;;
            "billing") npx playwright test --grep @billing ;;
            *) npm run test:ui:smoke ;;
          esac

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: reports
          path: |
            playwright-report/
            pytest-report.xml

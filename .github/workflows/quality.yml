name: Quality Gates
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to read commit messages accurately

      - name: Setup Node & Python
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps
          # Add 'requests' here so your Python tests can run
          pip install pytest pytest-json-report requests

      - name: Execute and Aggregate
        run: |
          MSG=$(git log -1 --pretty=%B)
          mkdir -p playwright-report

          # Set flags based on commit message
          [[ "$MSG" == *"#full"* ]] && RUN_ALL=true || RUN_ALL=false
          [[ "$MSG" == *"#regression"* ]] && RUN_REG=true || RUN_REG=false
          [[ "$MSG" == *"#perf"* ]] && RUN_PERF=true || RUN_PERF=false
          [[ "$MSG" == *"#smoke"* || ("$RUN_ALL" == false && "$RUN_REG" == false && "$RUN_PERF" == false) ]] && RUN_SMOKE=true || RUN_SMOKE=false

          # 1. PERFORMANCE
          if [[ "$RUN_ALL" == "true" ]] || [[ "$RUN_PERF" == "true" ]]; then
            k6 run tests_perf/smoke-load.js --summary-export=k6-summary.json || echo "k6 failed"
          fi

          # 2. API / BACKEND
          if [[ "$RUN_ALL" == "true" ]] || [[ "$RUN_REG" == "true" ]]; then
            pytest tests_python/ --json-report --json-report-file=api-report.json || echo "API failed"
          elif [[ "$RUN_SMOKE" == "true" ]]; then
            pytest tests_python/ -m smoke --json-report --json-report-file=api-report.json || echo "API smoke failed"
          fi

          # 3. UI / PLAYWRIGHT
          if [[ "$RUN_ALL" == "true" ]] || [[ "$RUN_REG" == "true" ]]; then
            npx playwright test --project=chromium --reporter=json > playwright-report/results.json || echo "UI full failed"
          else
            npx playwright test --grep @smoke --project=chromium --reporter=json > playwright-report/results.json || echo "UI smoke failed"
          fi

          node generate-dashboard.js

      - name: Upload Dashboard
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Quality-Dashboard
          path: dashboard.html

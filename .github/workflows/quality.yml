name: Unified Quality Gate
on: [push]

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.10' }

      - name: Install All Dependencies
        run: |
          npm ci
          npx playwright install --with-deps
          pip install pytest pytest-json-report requests
          # Install k6
          curl -L https://github.com/grafana/k6/releases/download/v0.49.0/k6-v0.49.0-linux-amd64.tar.gz | tar -xz
          sudo mv k6-v0.49.0-linux-amd64/k6 /usr/local/bin/

      - name: Execution Engine
        run: |
          MSG=$(git log -1 --pretty=%B)
          
          # 3.1 Always Run Smoke (API & UI)
          pytest tests_python/ -m smoke --json-report --json-report-file=api-report.json || true
          npx playwright test --grep @smoke --reporter=json > playwright-report/results.json || true

          # 3.2 Regression Logic
          if [[ "$MSG" == *"#regression"* || "$MSG" == *"#full"* ]]; then
            pytest tests_python/ --json-report --json-report-file=api-report.json || true
            npx playwright test --reporter=json > playwright-report/results.json || true
          fi

          # 3.4 Performance Logic
          if [[ "$MSG" == *"#performance"* || "$MSG" == *"#full"* ]]; then
            k6 run tests_perf/smoke-load.js --summary-export=k6-summary.json || true
          fi

      - name: Aggregate & Upload
        if: always()
        run: |
          node generate-dashboard.js
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Quality-Dashboard
          path: dashboard.html
name: Quality Gates
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to read commit messages accurately

      - name: Setup Node & Python
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          npm ci
          npx playwright install --with-deps
          pip install pytest requests

      - name: Execute and Aggregate
        run: |
          MSG=$(git log -1 --pretty=%B)
          mkdir -p playwright-report

          # Initialize empty JSONs so the aggregator doesn't die
          echo "{}" > playwright-report/results.json
          echo "{}" > api-report.json
          echo "{}" > k6-summary.json

          # 1. Performance (Only if tagged)
          if [[ "$MSG" == *"#full"* ]] || [[ "$MSG" == *"#perf"* ]]; then
            echo "Installing k6..."
            curl -L https://github.com/grafana/k6/releases/download/v0.49.0/k6-v0.49.0-linux-amd64.tar.gz | tar -xz
            # Move it to a global bin so you don't need the messy ./path/
            sudo cp k6-v0.49.0-linux-amd64/k6 /usr/local/bin/
            
            echo "Running k6..."
            k6 run tests_perf/smoke-load.js --summary-export=k6-summary.json
          fi

          # 2. API (Only if tagged)
          if [[ "$MSG" == *"#full"* ]] || [[ "$MSG" == *"#api"* ]]; then
            echo "Running Pytest..."
            timeout 5m pytest tests_python/ --json-report --json-report-file=api-report.json || echo "API Failed or Timed out"
          fi

          # 3. UI (Headless & Fast)
          echo "Running UI..."
          # If #full, run all. If not, run smoke.
          TARGET_GREP=$([[ "$MSG" == *"#full"* ]] && echo "" || echo "@smoke")
          timeout 5m npx playwright test --grep "$TARGET_GREP" --project=chromium --workers=1 --reporter=json > playwright-report/results.json || echo "UI Failed or Timed out"

          # 4. Aggregate
          node generate-dashboard.js

      - name: Upload Dashboard
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Quality-Dashboard
          path: dashboard.html
